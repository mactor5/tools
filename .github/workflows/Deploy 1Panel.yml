name: Deploy 1Panel

on:
  workflow_dispatch:
    inputs:
      panel-version:
        description: 'éƒ¨ç½² 1Panel ç‰ˆæœ¬'
        required: true
        default: 'v2'
        type: choice
        options:
          - 'v1'
          - 'v2'

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - name: è¿å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        id: check_server
        run: |
          echo -e "å·²çŸ¥CPUå‹å·(æ€§èƒ½é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep 'physical id' | sort | uniq | wc -l)"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
          echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
          echo "--------------------------ç½‘ç»œä¿¡æ¯--------------------------"
          curl -s -4 ipinfo.io > raw_net_info
          cat raw_net_info | jq -r '
            "IPåœ°å€           \(.ip)\n" +
            "æ‰€åœ¨åŸå¸‚         \(.city)\n" +
            "æ‰€åœ¨åŒºåŸŸ         \(.region)\n" +
            "å›½å®¶             \(.country)\n" +
            "åœ°ç†ä½ç½®         \(.loc)\n" +
            "ç»„ç»‡             \(.org)\n" +
            "é‚®æ”¿ç¼–ç          \(.postal)\n" +
            "æ‰€åœ¨æ—¶åŒº         \(.timezone)\n"'

          echo "public_ip=$(cat raw_net_info | jq -r '.ip')" >> $GITHUB_OUTPUT
          echo "city=$(cat raw_net_info | jq -r '.city')" >> $GITHUB_OUTPUT
          echo "region=$(cat raw_net_info | jq -r '.region')" >> $GITHUB_OUTPUT
          echo "country=$(cat raw_net_info | jq -r '.country')" >> $GITHUB_OUTPUT
          echo "loc=$(cat raw_net_info | jq -r '.loc')" >> $GITHUB_OUTPUT
          echo "org=$(cat raw_net_info | jq -r '.org')" >> $GITHUB_OUTPUT
          echo "postal=$(cat raw_net_info | jq -r '.postal')" >> $GITHUB_OUTPUT
          echo "timezone=$(cat raw_net_info | jq -r '.timezone')" >> $GITHUB_OUTPUT

      - name: åŠ å…¥Tailscaleç§æœ‰ç½‘ç»œ
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:githubactions
          version: latest

      - name: æŸ¥çœ‹IPåœ°å€
        id: get_local_ip
        run: |
          ip a
          LOCAL_IP=$(ip -o -4 addr list | awk '/100\./ {print $4}' | cut -d/ -f1)
          echo "æå–åˆ°æœ¬åœ° IP: ${LOCAL_IP}"
          echo "local_ip=${LOCAL_IP}" >> $GITHUB_OUTPUT

      - name: ä¿®æ”¹Dockerå­˜å‚¨è·¯å¾„
        run: |
          sudo systemctl stop docker
          sudo systemctl stop docker.socket
          sudo systemctl stop containerd
          sudo mkdir -p /mnt/dockerimg
          sudo echo '{"data-root": "/mnt/dockerimg"}' | sudo tee /etc/docker/daemon.json
          sudo systemctl daemon-reload
          sudo systemctl start docker
          docker info | grep "Docker Root Dir"

      - name: å®‰è£…1Panel
        id: install_1panel
        run: |
          if [ "${{ github.event.inputs.panel-version }}" == "v1" ]; then
            echo "æ­£åœ¨å®‰è£… 1Panel V1..."
            curl -sSL https://resource.fit2cloud.com/1panel/package/quick_start.sh -o quick_start.sh
          else
            echo "æ­£åœ¨å®‰è£… 1Panel V2..."
            curl -sSL https://resource.fit2cloud.com/1panel/package/v2/quick_start.sh -o quick_start.sh
          fi
          printf "2\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n" | sudo bash quick_start.sh
          
          sudo 1pctl user-info > panel_info.txt
          cat panel_info.txt
          PANEL_URL=$(awk '{sub(/\$LOCAL_IP/, "${{ steps.get_local_ip.outputs.local_ip }}"); gsub(/é¢æ¿åœ°å€: /, ""); print; exit}' panel_info.txt)
          echo $PANEL_URL

          PANEL_USER=$(sed -n '2s/é¢æ¿ç”¨æˆ·: //p' panel_info.txt)
          echo $PANEL_USER

          PANEL_PASSWORD=$(sed -n '3s/é¢æ¿å¯†ç : //p' panel_info.txt)
          echo $PANEL_PASSWORD
          
          echo "panel_url=${PANEL_URL}" >> $GITHUB_OUTPUT
          echo "panel_user=${PANEL_USER}" >> $GITHUB_OUTPUT
          echo "panel_password=${PANEL_PASSWORD}" >> $GITHUB_OUTPUT

      - name: å‘é€é€šçŸ¥
        run: |
          # è·å–å½“å‰åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
          CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S" -d "+8 hours")

          MESSAGE=$(cat <<EOF
          <b>ğŸ¯ 1Panel ${{ github.event.inputs.panel-version }} éƒ¨ç½²å®Œæˆ ğŸš€</b>

          ğŸ–¥ï¸ <b>å…¬ç½‘ IP:</b> <code>${{ steps.check_server.outputs.public_ip }}</code>  
          ğŸ  <b>æœ¬åœ° IP:</b> <code>${{ steps.get_local_ip.outputs.local_ip }}</code>  
          ğŸ™ï¸ <b>åŸå¸‚:</b> <code>${{ steps.check_server.outputs.city }}</code>  
          ğŸŒ <b>åŒºåŸŸ:</b> <code>${{ steps.check_server.outputs.region }}</code>  
          ğŸ“ <b>åœ°ç†ä½ç½®:</b> <code>${{ steps.check_server.outputs.loc }}</code>  
          ğŸ¢ <b>ç»„ç»‡:</b> <code>${{ steps.check_server.outputs.org }}</code>  
          ğŸ“® <b>é‚®æ”¿ç¼–ç :</b> <code>${{ steps.check_server.outputs.postal }}</code>  
          â° <b>æ—¶åŒº:</b> <code>${{ steps.check_server.outputs.timezone }}</code>  

          ğŸ”— <b>é¢æ¿ç®¡ç†åœ°å€:</b>  
          ğŸ“Œ <code>${{ steps.install_1panel.outputs.panel_url }}</code>  
          ğŸ‘¤ <b>ç”¨æˆ·å:</b> <code>${{ steps.install_1panel.outputs.panel_user }}</code>  
          ğŸ”‘ <b>å¯†ç :</b> <code>${{ steps.install_1panel.outputs.panel_password }}</code>  

          ğŸ•’ <b>å½“å‰æ—¶é—´:</b> <code>$CURRENT_TIME</code>  
          EOF
          )

          MESSAGE=$(echo "$MESSAGE" | jq -sRr @uri)

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
               -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
               -d "parse_mode=HTML" \
               -d "text=$MESSAGE"


      - name: å¯åŠ¨SSHç»ˆç«¯
        uses: mxschmitt/action-tmate@v3

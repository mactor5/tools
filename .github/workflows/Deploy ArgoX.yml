name: Deploy ArgoX

on:
  workflow_dispatch:
    inputs:
      cdn_server:
        description: 'CDN SERVER'
        required: true
        default: 'ip.sb'

jobs:
  Server:
    runs-on: ubuntu-latest
    steps:
      - name: è¿å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        id: check_server
        run: |
          echo -e "å·²çŸ¥CPUå‹å·(æ€§èƒ½é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep 'physical id' | sort | uniq | wc -l)"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
          echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
          echo "--------------------------ç½‘ç»œä¿¡æ¯--------------------------"
          curl -s -4 ipinfo.io > raw_net_info
          cat raw_net_info | jq -r '
            "IPåœ°å€           \(.ip)\n" +
            "æ‰€åœ¨åŸå¸‚         \(.city)\n" +
            "æ‰€åœ¨åŒºåŸŸ         \(.region)\n" +
            "å›½å®¶             \(.country)\n" +
            "åœ°ç†ä½ç½®         \(.loc)\n" +
            "ç»„ç»‡             \(.org)\n" +
            "é‚®æ”¿ç¼–ç          \(.postal)\n" +
            "æ‰€åœ¨æ—¶åŒº         \(.timezone)\n"' 

          echo "public_ip=$(cat raw_net_info | jq -r '.ip')" >> $GITHUB_OUTPUT
          echo "city=$(cat raw_net_info | jq -r '.city')" >> $GITHUB_OUTPUT
          echo "region=$(cat raw_net_info | jq -r '.region')" >> $GITHUB_OUTPUT
          echo "country=$(cat raw_net_info | jq -r '.country')" >> $GITHUB_OUTPUT
          echo "loc=$(cat raw_net_info | jq -r '.loc')" >> $GITHUB_OUTPUT
          echo "org=$(cat raw_net_info | jq -r '.org')" >> $GITHUB_OUTPUT
          echo "postal=$(cat raw_net_info | jq -r '.postal')" >> $GITHUB_OUTPUT
          echo "timezone=$(cat raw_net_info | jq -r '.timezone')" >> $GITHUB_OUTPUT

      - name: å¼€å¯BBR
        run: |
          sudo modprobe tcp_bbr
          sudo echo "tcp_bbr" | sudo tee --append /etc/modules-load.d/modules.conf
          sudo echo "net.core.default_qdisc=fq" | sudo tee --append /etc/sysctl.conf
          sudo echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee --append /etc/sysctl.conf
          sudo sysctl -p
          sudo sysctl net.ipv4.tcp_available_congestion_control
          sudo sysctl net.ipv4.tcp_congestion_control

      - name: å®‰è£… ArgoX
        run: |
          cat > config.conf << 'EOF'
          # ä½¿ç”¨è¯´æ˜ / Usage:
          # 1. å¤åˆ¶æ­¤æ–‡ä»¶å¹¶é‡å‘½åä¸º config.conf / Copy this file and rename it to config.conf
          # 2. æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®å‚æ•° / Modify the configuration parameters as needed
          # 3. æ‰§è¡Œå®‰è£…å‘½ä»¤ / Run the installation command:
          #    bash <(wget -qO- https://raw.githubusercontent.com/fscarmen/ArgoX/main/sing-box.sh) -f config.conf

          # é…ç½®æ–‡ä»¶è¯´æ˜ / Configuration Description:

          # è¯­è¨€é€‰é¡¹ / Language option: 
          # C ä¸ºä¸­æ–‡ / C for Chinese
          # E ä¸ºè‹±æ–‡ / E for English
          # ç•™ç©ºé»˜è®¤ä¸ºè‹±æ–‡ / Default is English if left empty
          L='C'

          # æœåŠ¡å™¨ IP åœ°å€ï¼Œæ”¯æŒ IPv4 æˆ– IPv6 / Server IP address, supports IPv4 or IPv6
          # ä¾‹å¦‚ / For example: IPv4: 123.123.123.123; IPv6: 2a01:4f8:272:5aa1:dc88:ff6e:5305:1234
          SERVER_IP=''

          # Argo é…ç½® / Argo Configuration
          # Argo åŸŸåè®¾ç½® / Argo domain settings
          # ä¾‹å¦‚ / For example: ARGO_DOMAIN='argo.xray.com'
          # ç•™ç©ºåˆ™ä½¿ç”¨ä¸´æ—¶éš§é“ / Use temporary tunnel if left empty
          ARGO_DOMAIN=''

          # Argo è®¤è¯ä¿¡æ¯ / Argo authentication info
          # JSON æ ¼å¼ç¤ºä¾‹ / JSON format example: 
          # ARGO_AUTH='{"AccountTag":"9cc9e3e4dag29d2a02e297f14f20513a","TunnelSecret":"vRzeQmSagqjCoQ0mzvl0qDR8dVROE889m0TnbZhJKHs=","TunnelID":"acd8c712-b088-4660-8187-e69abfa38443"}'
          # Token æ ¼å¼ç¤ºä¾‹ / Token format example:
          # ARGO_AUTH='eyJhIjoiOWNjOWUzZTRkOGYyOWQyYTAyZTI5N2YxNagyFzUxM2EiLCJ0IjoiYTcyMmUwNjYtODlmYi00ZjJmLTgagDQtOGEwOTVhNTkzM2I2IiwicyI6Ik9XTTFaak0xWWprdE16QTRNQzAwTUdVMExUbGlaV0V0TmpFek9UZzFNRGczWkdRNCJ9'
          # ç•™ç©ºåˆ™ä½¿ç”¨ä¸´æ—¶éš§é“ / Use temporary tunnel if left empty
          ARGO_AUTH=''

          # Xray é…ç½® / Xray Configuration
          # Reality ç«¯å£ / Reality port
          # ç•™ç©ºåˆ™éšæœºç”Ÿæˆ / Random generation if left empty
          REALITY_PORT=''

          # Reality ç§é’¥ / Reality private key
          # ç•™ç©ºåˆ™éšæœºç”Ÿæˆ / Random generation if left empty
          REALITY_PRIVATE=''

          # Reality å…¬é’¥ / Reality public key
          # ç•™ç©ºåˆ™éšæœºç”Ÿæˆ / Random generation if left empty
          REALITY_PUBLIC=''

          # æœåŠ¡å™¨åŸŸå / Server domain
          # ç•™ç©ºåˆ™ä½¿ç”¨è„šæœ¬é™„å¸¦çš„ç¬¬ä¸€ä¸ªCDN SERVER / Default to use the first CDN SERVER provided by the script if left empty
          SERVER='${{ github.event.inputs.cdn_server }}'

          # ç”¨æˆ· UUID / User UUID
          # ç•™ç©ºåˆ™éšæœºç”Ÿæˆ / Random generation if left empty
          UUID=''

          # WebSocket è·¯å¾„ / WebSocket path
          # ç•™ç©ºåˆ™é»˜è®¤ä¸º argox / Default is argox if left empty
          WS_PATH=''

          # èŠ‚ç‚¹åç§° / Node name
          # ç•™ç©ºåˆ™é»˜è®¤ä½¿ç”¨ VPS hostname / Default to VPS hostname if left empty
          NODE_NAME=''

          # è®¢é˜…é…ç½® / Subscribe Configuration
          # æ˜¯å¦å®‰è£… Nginx ç”¨äºè®¢é˜… / Install Nginx for subscription or not [y/n]
          # é»˜è®¤ä¸º y / Default is y
          INSTALL_NGINX='n'
          EOF

          wget https://raw.githubusercontent.com/fscarmen/argox/main/argox.sh
          chmod +x argox.sh
          sudo ./argox.sh -f config.conf >> /dev/null ||echo "å®‰è£…å®Œæˆ"
          sudo argox -n >> node.txt || echo "è·å–å®Œæˆ"
          awk 'NR==14' node.txt > new_node.txt


      - name: å‘é€ Telegram é€šçŸ¥
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆUTC+8 æ—¶åŒºï¼ŒåŒ—äº¬æ—¶é—´ï¼‰
          current_time=$(date -u +"%Y-%m-%d %H:%M:%S" -d "8 hour")

          # è¯»å–èŠ‚ç‚¹ä¿¡æ¯
          node_info=$(cat new_node.txt)

          # æ„é€  Telegram æ¶ˆæ¯
          message=$(cat <<EOF
          <b>ğŸš€ èŠ‚ç‚¹éƒ¨ç½²æˆåŠŸ ğŸ‰</b>

          ğŸ–¥ï¸ <b>å…¬ç½‘ IP:</b> <code>${{ steps.check_server.outputs.public_ip }}</code>  
          ğŸ™ï¸ <b>åŸå¸‚:</b> <code>${{ steps.check_server.outputs.city }}</code>  
          ğŸŒ <b>åŒºåŸŸ:</b> <code>${{ steps.check_server.outputs.region }}</code>  
          ğŸ—ºï¸ <b>å›½å®¶:</b> <code>${{ steps.check_server.outputs.country }}</code>  
          ğŸ“ <b>åœ°ç†ä½ç½®:</b> <code>${{ steps.check_server.outputs.loc }}</code>  
          ğŸ¢ <b>ç»„ç»‡:</b> <code>${{ steps.check_server.outputs.org }}</code>  
          ğŸ“® <b>é‚®æ”¿ç¼–ç :</b> <code>${{ steps.check_server.outputs.postal }}</code>  
          â° <b>æ—¶åŒº:</b> <code>${{ steps.check_server.outputs.timezone }}</code>  

          ğŸ“Œ <b>èŠ‚ç‚¹è¿æ¥ä¿¡æ¯:</b>  
          <code>$node_info</code>  
          
          ğŸ•’ <b>å½“å‰æ—¶é—´:</b> <code>$current_time</code>  
          EOF
          )

          # è¿›è¡Œ URL ç¼–ç 
          message=$(echo "$message" | jq -sRr @uri)

          # å‘é€ Telegram æ¶ˆæ¯
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
               -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
               -d "parse_mode=HTML" \
               -d "text=$message"  >> /dev/null
          echo "Telegram æ¶ˆæ¯å‘é€æˆåŠŸ"

      - name: å¯åŠ¨SSHç»ˆç«¯
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 120

      - name: å‘é€æç¤º
        if: ${{ always() }}
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆUTC+8 æ—¶åŒºï¼ŒåŒ—äº¬æ—¶é—´ï¼‰
          current_time=$(date -u +"%Y-%m-%d %H:%M:%S" -d "8 hour")

          # è¯»å–èŠ‚ç‚¹ä¿¡æ¯
          node_info=$(cat new_node.txt)

          # æ„é€  Telegram æ¶ˆæ¯
          message=$(cat <<EOF
          ğŸ“Œ <b>èŠ‚ç‚¹å·²å…³é—­</b>  
          EOF
          )

          # è¿›è¡Œ URL ç¼–ç 
          message=$(echo "$message" | jq -sRr @uri)

          # å‘é€ Telegram æ¶ˆæ¯
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
               -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
               -d "parse_mode=HTML" \
               -d "text=$message"  >> /dev/null
          echo "Telegram æ¶ˆæ¯å‘é€æˆåŠŸ"
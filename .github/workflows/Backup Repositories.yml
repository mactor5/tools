# å·¥ä½œæµåç§°
name: Backup Repositories

# è§¦å‘å™¨ï¼šå…è®¸æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      repository_url:
        description: 'ä»“åº“åœ°å€'
        required: true
        default: 'https://github.com/nginx/nginx'

# å®šä¹‰ä»»åŠ¡
jobs:
  Backup:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # ä»»åŠ¡æ­¥éª¤
    steps:
      # æ­¥éª¤ 1: ä»è¾“å…¥çš„ URL ä¸­æå–ä»“åº“åç§°ï¼Œå¹¶ç”Ÿæˆæ—¶é—´æˆ³å’Œæœ€ç»ˆæ–‡ä»¶å
      - name: Generate Backup Info
        id: info
        run: |
          # ä» URL ä¸­æå–ä»“åº“å
          REPO_NAME=$(basename ${{ github.event.inputs.repository_url }})
          echo "REPO_NAME=${REPO_NAME}" >> $GITHUB_ENV

          # ç”Ÿæˆä¸€ä¸ªæ ¼å¼åŒ–çš„æ—¶é—´æˆ³
          TIMESTAMP=$(date +'%Y%m%d-%H%M')
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          
          # ç”Ÿæˆæœ€ç»ˆçš„å‹ç¼©åŒ…æ–‡ä»¶å (ä¾‹å¦‚ nginx-20250817-1030.zip)
          ZIP_FILENAME="${REPO_NAME}-${TIMESTAMP}.zip"
          echo "ZIP_FILENAME=${ZIP_FILENAME}" >> $GITHUB_ENV
          
          echo "ä»“åº“åç§°: ${REPO_NAME}"
          echo "å¤‡ä»½æ–‡ä»¶å: ${ZIP_FILENAME}"

      # æ­¥éª¤ 2: ä¸‹è½½ä»“åº“çš„ .zip å‹ç¼©åŒ…
      - name: Download Repository Archive
        run: |
          # æ„é€ ä¸¤ç§å¯èƒ½çš„ä¸‹è½½é“¾æ¥ (é’ˆå¯¹ main å’Œ master åˆ†æ”¯)
          DOWNLOAD_URL_MAIN="${{ github.event.inputs.repository_url }}/archive/refs/heads/main.zip"
          DOWNLOAD_URL_MASTER="${{ github.event.inputs.repository_url }}/archive/refs/heads/master.zip"
          
          echo "å°è¯•ä» main åˆ†æ”¯ä¸‹è½½: ${DOWNLOAD_URL_MAIN}"
          # ä½¿ç”¨ wget ä¸‹è½½å¹¶ç›´æ¥ä¿å­˜ä¸ºæˆ‘ä»¬æŒ‡å®šçš„æ–‡ä»¶å
          # å¦‚æœä» main ä¸‹è½½å¤±è´¥ (wget è¿”å›é0é€€å‡ºç ), "||" ä¼šæ‰§è¡Œåé¢çš„å‘½ä»¤ï¼Œå°è¯•ä» master ä¸‹è½½
          wget -q --show-progress -O "${{ env.ZIP_FILENAME }}" "${DOWNLOAD_URL_MAIN}" || \
          (echo "ä» main åˆ†æ”¯ä¸‹è½½å¤±è´¥, å°è¯• master åˆ†æ”¯..." && wget -q --show-progress -O "${{ env.ZIP_FILENAME }}" "${DOWNLOAD_URL_MASTER}")

          echo "ä¸‹è½½å®Œæˆ, æ–‡ä»¶å·²ä¿å­˜ä¸º: ${{ env.ZIP_FILENAME }}"

      # æ­¥éª¤ 3: å°†å¤‡ä»½æ–‡ä»¶å‘é€åˆ° Telegram
      - name: Send to Telegram
        run: |
          CAPTION=$(printf "ğŸš€ å¤‡ä»½å®Œæˆ\nğŸŒ ä»“åº“åœ°å€ï¼š${{ github.event.inputs.repository_url }}\nğŸ”— #æ‰‹åŠ¨å¤‡ä»½")

          curl -X POST "https://api.telegram.org/bot${{ secrets.FL_TELEGRAM_TOKEN }}/sendDocument" \
               -F chat_id="${{ secrets.TELEGRAM_TO }}" \
               -F document=@"${{ env.ZIP_FILENAME }}" \
               -F caption="$CAPTION" \
               -F parse_mode="HTML"

      # æ­¥éª¤ 4: å°†å¤‡ä»½æ–‡ä»¶ä¸Šä¼ åˆ° GitHub Actions çš„ Artifacts
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # Artifacts çš„åç§°
          name: backup-${{ env.REPO_NAME }}
          # è¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
          path: ${{ env.ZIP_FILENAME }}
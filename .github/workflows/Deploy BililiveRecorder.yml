name: Deploy BililiveRecorder

on:
  workflow_dispatch:

jobs:
  Server:
    runs-on: ubuntu-24.04
    steps:
      - name: è¿å‡ºä»£ç 
        uses: actions/checkout@v3
        
      - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        id: check_server
        run: |
          echo -e "å·²çŸ¥CPUå‹å·(æ€§èƒ½é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep 'physical id' | sort | uniq | wc -l)"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
          echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
          echo "--------------------------ç½‘ç»œä¿¡æ¯--------------------------"
          curl -s -4 ipinfo.io > raw_net_info
          cat raw_net_info | jq -r '
            "IPåœ°å€           \(.ip)\n" +
            "æ‰€åœ¨åŸå¸‚         \(.city)\n" +
            "æ‰€åœ¨åŒºåŸŸ         \(.region)\n" +
            "å›½å®¶             \(.country)\n" +
            "åœ°ç†ä½ç½®         \(.loc)\n" +
            "ç»„ç»‡             \(.org)\n" +
            "é‚®æ”¿ç¼–ç          \(.postal)\n" +
            "æ‰€åœ¨æ—¶åŒº         \(.timezone)\n"' 

          echo "public_ip=$(cat raw_net_info | jq -r '.ip')" >> $GITHUB_OUTPUT
          echo "city=$(cat raw_net_info | jq -r '.city')" >> $GITHUB_OUTPUT
          echo "region=$(cat raw_net_info | jq -r '.region')" >> $GITHUB_OUTPUT
          echo "country=$(cat raw_net_info | jq -r '.country')" >> $GITHUB_OUTPUT
          echo "loc=$(cat raw_net_info | jq -r '.loc')" >> $GITHUB_OUTPUT
          echo "org=$(cat raw_net_info | jq -r '.org')" >> $GITHUB_OUTPUT
          echo "postal=$(cat raw_net_info | jq -r '.postal')" >> $GITHUB_OUTPUT
          echo "timezone=$(cat raw_net_info | jq -r '.timezone')" >> $GITHUB_OUTPUT

      - name: åŠ å…¥Tailscaleç§æœ‰ç½‘ç»œ
        uses: tailscale/github-action@v3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:githubactions
          version: latest

      - name: å¼€å¯BBRåŠ é€Ÿ
        run: |
          cat > bbr.sh << 'EOF'
          enable_bbr() {
              if grep -q "net.core.default_qdisc=fq" /etc/sysctl.conf && grep -q "net.ipv4.tcp_congestion_control=bbr" /etc/sysctl.conf; then
                  echo -e "BBR is already enabled!"
                  return
              fi

              # Enable BBR
              echo "net.core.default_qdisc=fq" | tee -a /etc/sysctl.conf
              echo "net.ipv4.tcp_congestion_control=bbr" | tee -a /etc/sysctl.conf

              # Apply changes
              sysctl -p

              # Verify that BBR is enabled
              if [[ $(sysctl net.ipv4.tcp_congestion_control | awk '{print $3}') == "bbr" ]]; then
                  echo -e "BBR has been enabled successfully."
              else
                  echo -e "${red}Failed to enable BBR. Please check your system configuration."
              fi
          }

          enable_bbr
          EOF
          sudo bash bbr.sh

      - name: æŸ¥çœ‹IPåœ°å€
        id: get_local_ip
        run: |
          ip a
          LOCAL_IP=$(ip -o -4 addr list | awk '/100\./ {print $4}' | cut -d/ -f1)
          echo "æå–åˆ°æœ¬åœ° IP: ${LOCAL_IP}"
          echo "local_ip=${LOCAL_IP}" >> $GITHUB_OUTPUT

      - name: è®¾ç½®ç¯å¢ƒ
        run: |
          sudo apt update
          mkdir upload
          echo "ä¸Šä¼ æ–‡ä»¶ç›®å½•: $(pwd)/upload"
            
      - name: éƒ¨ç½² BililiveRecorder
        run: |
          cat > ./upload/config.json << 'EOF'
          {"version":3,"global":{"CuttingMode":{"HasValue":true,"Value":2},"CuttingNumber":{"HasValue":true,"Value":2000},"CuttingByTitle":{"HasValue":true,"Value":true},"RecordDanmaku":{"HasValue":true,"Value":true},"RecordDanmakuRaw":{"HasValue":true,"Value":true},"RecordDanmakuGift":{"HasValue":true,"Value":true},"SaveStreamCover":{"HasValue":true,"Value":true},"FileNameRecordTemplate":{"HasValue":true,"Value":"å½•åˆ¶-{{ name }}-{{ \"now\" | time_zone: \"Asia/Shanghai\" | format_date: \"yyyyMMdd-HHmmss-fff\" }}-{{ title }}.flv"},"FlvProcessorSplitOnScriptTag":{"HasValue":true,"Value":true}},"rooms":[{"RoomId":{"HasValue":true,"Value":21669525},"AutoRecord":{"HasValue":true,"Value":true}}]}
          EOF

          cat > docker-compose.yml << 'EOF'
          version: "3.8"
          services:
            recorder:
              image: bililive/recorder:latest
              restart: unless-stopped
              volumes:
                - type: bind
                  source: ./upload # åœ¨è¿™é‡Œå†™å®¿ä¸»æœºä¿å­˜å½•æ’­çš„è·¯å¾„
                  target: /rec
              ports:
                - "80:2356"
                # ç¬¬ä¸€ä¸ª 2356 æ˜¯å®¿ä¸»æœºçš„ç«¯å£ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±éœ€æ±‚æ”¹åŠ¨ã€‚
                # ç¬¬äºŒä¸ª 2356 æ˜¯å®¹å™¨å†…çš„ç«¯å£ï¼Œä¸è¦ä¿®æ”¹ã€‚
              environment:
                - BREC_HTTP_BASIC_USER=
                - BREC_HTTP_BASIC_PASS=
                - UMASK=022
                # # (é«˜çº§å‚æ•°ï¼Œéå¿…å¡«)è¿™ä¸ªå€¼ç”¨äºæ§åˆ¶é•œåƒå†™å‡ºçš„æ–‡ä»¶æƒé™ï¼Œ002ä¸ºå½“å‰ç”¨æˆ·&å½“å‰ç”¨æˆ·ç»„å¯è¯»å†™ï¼Œé»˜è®¤å€¼022ä¸ºå½“å‰ç”¨æˆ·å¯è¯»å†™ï¼Œå…¶ä»–ç”¨æˆ·åªè¯»
                # - PUID=1000
                # # (é«˜çº§å‚æ•°ï¼Œéå¿…å¡«)è¿™ä¸ªå€¼ç”¨äºæ§åˆ¶æ–‡ä»¶æ‰€æœ‰è€…ï¼Œå»ºè®®è®¾ç½®ä¸ºå®¿ä¸»æœºçš„ç”¨æˆ·çš„UIDæˆ–è€…å’Œå®¿ä¸»æœºç”¨æˆ·ç›¸åŒç”¨æˆ·ç»„çš„ç”¨æˆ·çš„UID
                # - PGID=1000
                # # (é«˜çº§å‚æ•°ï¼Œéå¿…å¡«)è¿™ä¸ªå€¼ç”¨äºæ§åˆ¶æ–‡ä»¶æ‰€æœ‰è€…æ‰€å±çš„ç”¨æˆ·ç»„ï¼Œå»ºè®®è®¾ç½®ä¸ºå®¿ä¸»æœºçš„ç”¨æˆ·ç›¸åŒçš„ç”¨æˆ·ç»„çš„GID
                    
          EOF
          docker compose up -d

      - name: å‘é€ Telegram é€šçŸ¥
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆUTC+8 æ—¶åŒºï¼ŒåŒ—äº¬æ—¶é—´ï¼‰
          current_time=$(date -u +"%Y-%m-%d %H:%M:%S" -d "8 hour")

          # æ„é€  Telegram æ¶ˆæ¯
          message=$(cat <<EOF
          <b>ğŸš€ BililiveRecorder éƒ¨ç½²æˆåŠŸ ğŸ‰</b>

          ğŸ–¥ï¸ <b>å…¬ç½‘ IP:</b> <code>${{ steps.check_server.outputs.public_ip }}</code>  
          ğŸ  <b>æœ¬åœ° IP:</b> <code>${{ steps.get_local_ip.outputs.local_ip }}</code>  
          ğŸ™ï¸ <b>åŸå¸‚:</b> <code>${{ steps.check_server.outputs.city }}</code>  
          ğŸŒ <b>åŒºåŸŸ:</b> <code>${{ steps.check_server.outputs.region }}</code>  
          ğŸ—ºï¸ <b>å›½å®¶:</b> <code>${{ steps.check_server.outputs.country }}</code>  
          ğŸ“ <b>åœ°ç†ä½ç½®:</b> <code>${{ steps.check_server.outputs.loc }}</code>  
          ğŸ¢ <b>ç»„ç»‡:</b> <code>${{ steps.check_server.outputs.org }}</code>  
          ğŸ“® <b>é‚®æ”¿ç¼–ç :</b> <code>${{ steps.check_server.outputs.postal }}</code>  
          â° <b>æ—¶åŒº:</b> <code>${{ steps.check_server.outputs.timezone }}</code>  

          ğŸ•’ <b>å½“å‰æ—¶é—´:</b> <code>$current_time</code>  
          EOF
          )

          # è¿›è¡Œ URL ç¼–ç 
          message=$(echo "$message" | jq -sRr @uri)

          # å‘é€ Telegram æ¶ˆæ¯
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
               -d "chat_id=${{ secrets.TELEGRAM_TO }}" \
               -d "parse_mode=HTML" \
               -d "text=$message"

      - name: å¯åŠ¨SSHç»ˆç«¯
        uses: mxschmitt/action-tmate@v3

      - name: ä¸Šä¼ æ–‡ä»¶
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: my-artifact
          path: upload
